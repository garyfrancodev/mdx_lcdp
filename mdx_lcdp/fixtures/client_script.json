[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quotation",
  "enabled": 1,
  "modified": "2025-09-26 16:34:58.158828",
  "module": "Mdx Lcdp",
  "name": "Cotizacion_custom_cantidad_m2",
  "script": "// SCRIPT SEGURO Y ESTABLE PARA QUOTATION ITEM\r\nfrappe.ui.form.on('Quotation Item', {\r\n    qty: function(frm, cdt, cdn) {\r\n        calcular_m2(frm, cdt, cdn);\r\n        calcular_precio_m2(frm, cdt, cdn);\r\n    },\r\n    item_code: function(frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n        if (!row.qty || row.qty === 0) {\r\n            frappe.model.set_value(cdt, cdn, 'qty', 1);\r\n        }\r\n        \r\n        setTimeout(function() {\r\n            calcular_m2(frm, cdt, cdn);\r\n            calcular_precio_m2(frm, cdt, cdn);\r\n            \r\n            frappe.call({\r\n                method: \"frappe.client.get\",\r\n                args: { doctype: \"Item\", name: row.item_code },\r\n                callback: function(r) {\r\n                    if (r.message && r.message.uoms) {\r\n                        let uom_m2 = r.message.uoms.find(u => u.uom === \"m2\");\r\n                        if (!uom_m2) {\r\n                            frappe.call({\r\n                                method: \"frappe.client.get_list\",\r\n                                args: {\r\n                                    doctype: \"Item Price\",\r\n                                    fields: [\"price_list_rate\"],\r\n                                    filters: {\r\n                                        item_code: row.item_code,\r\n                                        price_list: frm.doc.selling_price_list,\r\n                                        selling: 1\r\n                                    },\r\n                                    limit_page_length: 1\r\n                                },\r\n                                callback: function(res) {\r\n                                    // Solo actualizamos el precio SI LO ENCONTRAMOS.\r\n                                    // Si no, no hacemos nada y dejamos el que puso ERPNext.\r\n                                    if (res.message && res.message.length > 0) {\r\n                                        frappe.model.set_value(cdt, cdn, 'rate', res.message[0].price_list_rate);\r\n                                        frm.refresh_field('items');\r\n                                    }\r\n                                }\r\n                            });\r\n                        }\r\n                    }\r\n                }\r\n            });\r\n        }, 150);\r\n    },\r\n    rate: function(frm, cdt, cdn) {\r\n        calcular_precio_m2(frm, cdt, cdn);\r\n    },\r\n    custom_cantidad_m2: function(frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n        if (row.item_code && row.custom_cantidad_m2) {\r\n            frappe.call({\r\n                method: \"frappe.client.get\",\r\n                args: { doctype: \"Item\", name: row.item_code },\r\n                callback: function(r) {\r\n                    if (r.message && r.message.uoms) {\r\n                        let uom_m2 = r.message.uoms.find(u => u.uom === \"m2\");\r\n                        if (uom_m2 && uom_m2.conversion_factor) {\r\n                            let cajas = row.custom_cantidad_m2 / uom_m2.conversion_factor;\r\n                            if (!Number.isInteger(cajas)) {\r\n                                let dialog = new frappe.ui.Dialog({\r\n                                    title: 'Redondeo de cantidad de cajas',\r\n                                    fields: [{\r\n                                        fieldtype: 'HTML',\r\n                                        options: `La cantidad ingresada en m² no equivale a un número entero de cajas.<br><br><b>Opción 1:</b> Redondear hacia abajo (<b>${Math.floor(cajas)}</b> cajas, <b>${(Math.floor(cajas) * uom_m2.conversion_factor).toFixed(2)}</b> m²)<br><b>Opción 2:</b> Redondear hacia arriba (<b>${Math.ceil(cajas)}</b> cajas, <b>${(Math.ceil(cajas) * uom_m2.conversion_factor).toFixed(2)}</b> m²)`\r\n                                    }],\r\n                                    primary_action_label: 'Opción 2 (Hacia arriba)',\r\n                                    primary_action: function() {\r\n                                        frappe.model.set_value(cdt, cdn, 'qty', Math.ceil(cajas));\r\n                                        dialog.hide();\r\n                                    },\r\n                                    secondary_action_label: 'Opción 1 (Hacia abajo)',\r\n                                    secondary_action: function() {\r\n                                        frappe.model.set_value(cdt, cdn, 'qty', Math.floor(cajas));\r\n                                        dialog.hide();\r\n                                    }\r\n                                });\r\n                                dialog.show();\r\n                            } else {\r\n                                frappe.model.set_value(cdt, cdn, 'qty', cajas);\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    }\r\n});\r\n\r\n// --- FUNCIONES AUXILIARES (Sin cambios) ---\r\nfunction calcular_m2(frm, cdt, cdn) {\r\n    let row = locals[cdt][cdn];\r\n    if (row.item_code && row.qty) {\r\n        frappe.call({\r\n            method: \"frappe.client.get\",\r\n            args: { doctype: \"Item\", name: row.item_code },\r\n            callback: function(r) {\r\n                if (r.message && r.message.uoms) {\r\n                    let uom_m2 = r.message.uoms.find(u => u.uom === \"m2\");\r\n                    if (uom_m2 && uom_m2.conversion_factor) {\r\n                        frappe.model.set_value(cdt, cdn, 'custom_cantidad_m2', row.qty * uom_m2.conversion_factor);\r\n                    } else {\r\n                        frappe.model.set_value(cdt, cdn, 'custom_cantidad_m2', 0);\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\nfunction calcular_precio_m2(frm, cdt, cdn) {\r\n    let row = locals[cdt][cdn];\r\n    if (row.item_code && row.rate) {\r\n        frappe.call({\r\n            method: \"frappe.client.get\",\r\n            args: { doctype: \"Item\", name: row.item_code },\r\n            callback: function(r) {\r\n                if (r.message && r.message.uoms) {\r\n                    let uom_m2 = r.message.uoms.find(u => u.uom === \"m2\");\r\n                    if (uom_m2 && uom_m2.conversion_factor) {\r\n                        let precio_m2 = row.rate / uom_m2.conversion_factor;\r\n                        frappe.model.set_value(cdt, cdn, 'custom_precio_m2', precio_m2);\r\n                    } else {\r\n                        frappe.model.set_value(cdt, cdn, 'custom_precio_m2', 0);\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    }\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quotation",
  "enabled": 1,
  "modified": "2025-09-09 17:03:13.932244",
  "module": "Mdx Lcdp",
  "name": "Cotizacion_actualizacion_um",
  "script": "frappe.ui.form.on('Quotation Item', {\r\n    item_code: function(frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n        if (row.item_code) {\r\n            frappe.call({\r\n                method: \"frappe.client.get\",\r\n                args: {\r\n                    doctype: \"Item\",\r\n                    name: row.item_code\r\n                },\r\n                callback: function(r) {\r\n                    if (r.message && r.message.stock_uom) {\r\n                        frappe.model.set_value(cdt, cdn, 'uom', r.message.stock_uom);\r\n                        frm.refresh_field('items');\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2025-09-10 18:44:17.234729",
  "module": "Mdx Lcdp",
  "name": "ov_actualizacion_um",
  "script": "frappe.ui.form.on('Sales Order Item', {\r\n    item_code: function(frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n        if (row.item_code) {\r\n            frappe.call({\r\n                method: \"frappe.client.get\",\r\n                args: {\r\n                    doctype: \"Item\",\r\n                    name: row.item_code\r\n                },\r\n                callback: function(r) {\r\n                    if (r.message && r.message.stock_uom) {\r\n                        frappe.model.set_value(cdt, cdn, 'uom', r.message.stock_uom);\r\n                        frm.refresh_field('items');\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2025-09-26 15:46:34.075733",
  "module": "Mdx Lcdp",
  "name": "ov_custom_cantidad_m2",
  "script": "// SCRIPT ORIGINAL DEL USUARIO CON CORRECCIÓN DE SOBREESCRITURA DE PRECIO\r\nfrappe.ui.form.on('Sales Order Item', {\r\n    qty: function(frm, cdt, cdn) {\r\n        calcular_m2(frm, cdt, cdn);\r\n        calcular_precio_m2(frm, cdt, cdn);\r\n    },\r\n    item_code: function(frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n        if (!row.qty || row.qty === 0) {\r\n            frappe.model.set_value(cdt, cdn, 'qty', 1);\r\n        }\r\n        \r\n        // Se unificó la lógica para no tener código duplicado\r\n        setTimeout(function() {\r\n            calcular_m2(frm, cdt, cdn);\r\n            calcular_precio_m2(frm, cdt, cdn);\r\n            \r\n            frappe.call({\r\n                method: \"frappe.client.get\",\r\n                args: { doctype: \"Item\", name: row.item_code },\r\n                callback: function(r) {\r\n                    if (r.message && r.message.uoms) {\r\n                        let uom_m2 = r.message.uoms.find(u => u.uom === \"m2\");\r\n                        if (!uom_m2) {\r\n                            frappe.call({\r\n                                method: \"frappe.client.get_list\",\r\n                                args: {\r\n                                    doctype: \"Item Price\",\r\n                                    fields: [\"price_list_rate\"],\r\n                                    filters: {\r\n                                        item_code: row.item_code,\r\n                                        price_list: frm.doc.selling_price_list,\r\n                                        selling: 1\r\n                                    },\r\n                                    limit_page_length: 1\r\n                                },\r\n                                callback: function(res) {\r\n                                    // --- INICIO DE LA CORRECCIÓN CLAVE ---\r\n                                    // Solo actualizamos el precio SI ENCONTRAMOS UNO.\r\n                                    // Si no, no hacemos nada y dejamos el que puso ERPNext.\r\n                                    if (res.message && res.message.length > 0) {\r\n                                        frappe.model.set_value(cdt, cdn, 'rate', res.message[0].price_list_rate);\r\n                                        frm.refresh_field('items');\r\n                                    }\r\n                                    // --- FIN DE LA CORRECCIÓN CLAVE ---\r\n                                }\r\n                            });\r\n                        }\r\n                    }\r\n                }\r\n            });\r\n        }, 150); // Aumentado ligeramente a 150ms por seguridad\r\n    },\r\n    rate: function(frm, cdt, cdn) {\r\n        calcular_precio_m2(frm, cdt, cdn);\r\n    },\r\n    custom_cantidad_m2: function(frm, cdt, cdn) {\r\n        // Tu lógica de redondeo (sin cambios)\r\n        let row = locals[cdt][cdn];\r\n        if (row.item_code && row.custom_cantidad_m2) {\r\n            frappe.call({\r\n                method: \"frappe.client.get\",\r\n                args: { doctype: \"Item\", name: row.item_code },\r\n                callback: function(r) {\r\n                    if (r.message && r.message.uoms) {\r\n                        let uom_m2 = r.message.uoms.find(u => u.uom === \"m2\");\r\n                        if (uom_m2 && uom_m2.conversion_factor) {\r\n                            let cajas = row.custom_cantidad_m2 / uom_m2.conversion_factor;\r\n                            if (!Number.isInteger(cajas)) {\r\n                                let dialog = new frappe.ui.Dialog({\r\n                                    title: 'Redondeo de cantidad de cajas',\r\n                                    fields: [{\r\n                                        fieldtype: 'HTML',\r\n                                        options: `La cantidad ingresada en m² no equivale a un número entero de cajas.<br><br><b>Opción 1:</b> Redondear hacia abajo (<b>${Math.floor(cajas)}</b> cajas, <b>${(Math.floor(cajas) * uom_m2.conversion_factor).toFixed(2)}</b> m²)<br><b>Opción 2:</b> Redondear hacia arriba (<b>${Math.ceil(cajas)}</b> cajas, <b>${(Math.ceil(cajas) * uom_m2.conversion_factor).toFixed(2)}</b> m²)`\r\n                                    }],\r\n                                    primary_action_label: 'Opción 2 (Hacia arriba)',\r\n                                    primary_action: function() {\r\n                                        frappe.model.set_value(cdt, cdn, 'qty', Math.ceil(cajas));\r\n                                        dialog.hide();\r\n                                    },\r\n                                    secondary_action_label: 'Opción 1 (Hacia abajo)',\r\n                                    secondary_action: function() {\r\n                                        frappe.model.set_value(cdt, cdn, 'qty', Math.floor(cajas));\r\n                                        dialog.hide();\r\n                                    }\r\n                                });\r\n                                dialog.show();\r\n                            } else {\r\n                                frappe.model.set_value(cdt, cdn, 'qty', cajas);\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    }\r\n});\r\n\r\n// --- FUNCIONES AUXILIARES (Sin cambios) ---\r\nfunction calcular_m2(frm, cdt, cdn) {\r\n    let row = locals[cdt][cdn];\r\n    if (row.item_code && row.qty) {\r\n        frappe.call({\r\n            method: \"frappe.client.get\",\r\n            args: { doctype: \"Item\", name: row.item_code },\r\n            callback: function(r) {\r\n                if (r.message && r.message.uoms) {\r\n                    let uom_m2 = r.message.uoms.find(u => u.uom === \"m2\");\r\n                    if (uom_m2 && uom_m2.conversion_factor) {\r\n                        frappe.model.set_value(cdt, cdn, 'custom_cantidad_m2', row.qty * uom_m2.conversion_factor);\r\n                    } else {\r\n                        frappe.model.set_value(cdt, cdn, 'custom_cantidad_m2', 0);\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\nfunction calcular_precio_m2(frm, cdt, cdn) {\r\n    let row = locals[cdt][cdn];\r\n    if (row.item_code && row.rate) {\r\n        frappe.call({\r\n            method: \"frappe.client.get\",\r\n            args: { doctype: \"Item\", name: row.item_code },\r\n            callback: function(r) {\r\n                if (r.message && r.message.uoms) {\r\n                    let uom_m2 = r.message.uoms.find(u => u.uom === \"m2\");\r\n                    if (uom_m2 && uom_m2.conversion_factor) {\r\n                        let precio_m2 = row.rate / uom_m2.conversion_factor;\r\n                        frappe.model.set_value(cdt, cdn, 'custom_precio_m2', precio_m2);\r\n                    } else {\r\n                        frappe.model.set_value(cdt, cdn, 'custom_precio_m2', 0);\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    }\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Price List",
  "enabled": 1,
  "modified": "2025-09-21 19:12:59.076439",
  "module": "Mdx Lcdp",
  "name": "LIsta_precios_actualizador_masivo_ventas",
  "script": "frappe.ui.form.on('Price List', {\n    refresh(frm) {\n        frm.add_custom_button('Actualizador masivo de precios', () => {\n            frappe.prompt([\n                {\n                    fieldname: 'porcentaje',\n                    label: 'Porcentaje de incremento (%)',\n                    fieldtype: 'Float',\n                    reqd: 1\n                }\n            ], (values) => {\n                frappe.call({\n                    method: 'mdx_lcdp.api.actualizar_precios_masivo',\n                    args: {\n                        price_list: frm.doc.name,\n                        porcentaje: values.porcentaje\n                    },\n                    callback: function(r) {\n                        frappe.msgprint({\n                            title: 'Resultado de la actualización',\n                            indicator: r.message.includes('exitosa') ? 'green' : 'red',\n                            message: r.message,\n                            wide: true\n                        });\n                        frm.reload_doc();\n                    }\n                });\n            }, 'Actualizar precios', 'Actualizar');\n        });\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quotation",
  "enabled": 1,
  "modified": "2025-09-24 22:14:03.468269",
  "module": "Mdx Lcdp",
  "name": "Fecha de validez de la cotizacion",
  "script": "frappe.ui.form.on('Quotation', {\n    onload: function(frm) {\n        if (!frm.doc.valid_till) {\n            let today = frappe.datetime.get_today();\n            let two_days_later = frappe.datetime.add_days(today, 2);\n            frm.set_value('valid_till', two_days_later);\n        }\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2025-09-26 11:37:01.114985",
  "module": "Mdx Lcdp",
  "name": "Valores predeterminados de entrada de inventario",
  "script": "frappe.ui.form.on('Stock Entry', {\r\n    onload: function(frm) {\r\n        if (!frm.doc.stock_entry_type) {\r\n            frm.set_value('stock_entry_type', 'Ingreso de productos');\r\n        }\r\n        if (!frm.doc.to_warehouse) {\r\n            frm.set_value('to_warehouse', 'Sucursales - L');\r\n        }\r\n    }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2025-09-26 13:52:06.482191",
  "module": "Mdx Lcdp",
  "name": "Valores predeterminados OV",
  "script": "frappe.ui.form.on('Sales Order', {\n    onload: function(frm) {\n        if (!frm.doc.delivery_date) {\n            frm.set_value('delivery_date', frappe.datetime.get_today());\n        }\n    }\n});",
  "view": "Form"
 }
]