[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quotation",
  "enabled": 1,
  "modified": "2025-09-08 18:40:39.186360",
  "module": "Mdx Lcdp",
  "name": "Cotizacion_custom_cantidad_m2",
  "script": "frappe.ui.form.on('Quotation Item', {\r\n    qty: function(frm, cdt, cdn) {\r\n        calcular_m2(frm, cdt, cdn);\r\n        calcular_precio_m2(frm, cdt, cdn);\r\n    },\r\n    item_code: function(frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n        // Si qty no está definido o es 0, inicialízalo en 1\r\n        if (!row.qty || row.qty === 0) {\r\n            frappe.model.set_value(cdt, cdn, 'qty', 1);\r\n            setTimeout(function() {\r\n                calcular_m2(frm, cdt, cdn);\r\n                calcular_precio_m2(frm, cdt, cdn);\r\n            }, 100);\r\n        } else {\r\n            calcular_m2(frm, cdt, cdn);\r\n            setTimeout(function() {\r\n                calcular_precio_m2(frm, cdt, cdn);\r\n            }, 100);\r\n        }\r\n    },\r\n    rate: function(frm, cdt, cdn) {\r\n        calcular_precio_m2(frm, cdt, cdn);\r\n    },\r\n    custom_cantidad_m2: function(frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n        if (row.item_code && row.custom_cantidad_m2) {\r\n            frappe.call({\r\n                method: \"frappe.client.get\",\r\n                args: {\r\n                    doctype: \"Item\",\r\n                    name: row.item_code\r\n                },\r\n                callback: function(r) {\r\n                    if (r.message && r.message.uoms) {\r\n                        let uom_m2 = r.message.uoms.find(u => u.uom === \"m2\");\r\n                        if (uom_m2 && uom_m2.conversion_factor) {\r\n                            let cajas = row.custom_cantidad_m2 / uom_m2.conversion_factor;\r\n                            if (!Number.isInteger(cajas)) {\r\n                                let dialog = new frappe.ui.Dialog({\r\n                                    title: 'Redondeo de cantidad de cajas',\r\n                                    fields: [\r\n                                        {\r\n                                            fieldtype: 'HTML',\r\n                                            fieldname: 'info',\r\n                                            options: `\r\n                                                <div>\r\n                                                    La cantidad ingresada en m² no equivale a un número entero de cajas.<br><br>\r\n                                                    <b>Opción 1:</b> Redondear hacia abajo (<b>${Math.floor(cajas)}</b> cajas, <b>${(Math.floor(cajas) * uom_m2.conversion_factor).toFixed(2)}</b> m²)<br>\r\n                                                    <b>Opción 2:</b> Redondear hacia arriba (<b>${Math.ceil(cajas)}</b> cajas, <b>${(Math.ceil(cajas) * uom_m2.conversion_factor).toFixed(2)}</b> m²)<br><br>\r\n                                                    Por favor, elige una opción:\r\n                                                </div>\r\n                                            `\r\n                                        }\r\n                                    ],\r\n                                    primary_action_label: '2',\r\n                                    primary_action: function() {\r\n                                        frappe.model.set_value(cdt, cdn, 'qty', Math.ceil(cajas));\r\n                                        frappe.model.set_value(cdt, cdn, 'custom_cantidad_m2', Math.ceil(cajas) * uom_m2.conversion_factor);\r\n                                        frm.refresh_field('items');\r\n                                        dialog.hide();\r\n                                    },\r\n                                    secondary_action_label: '1',\r\n                                    secondary_action: function() {\r\n                                        frappe.model.set_value(cdt, cdn, 'qty', Math.floor(cajas));\r\n                                        frappe.model.set_value(cdt, cdn, 'custom_cantidad_m2', Math.floor(cajas) * uom_m2.conversion_factor);\r\n                                        frm.refresh_field('items');\r\n                                        dialog.hide();\r\n                                    }\r\n                                });\r\n                                dialog.show();\r\n\r\n                                setTimeout(function() {\r\n                                    let buttons = dialog.$wrapper.find('.modal-footer button');\r\n                                    buttons.css({\r\n                                        'background': '#212121',\r\n                                        'color': '#fff',\r\n                                        'border': 'none'\r\n                                    });\r\n                                }, 100);\r\n                            } else {\r\n                                frappe.model.set_value(cdt, cdn, 'qty', cajas);\r\n                                frappe.model.set_value(cdt, cdn, 'custom_cantidad_m2', cajas * uom_m2.conversion_factor);\r\n                                frm.refresh_field('items');\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    }\r\n});\r\n\r\nfunction calcular_m2(frm, cdt, cdn) {\r\n    let row = locals[cdt][cdn];\r\n    if (row.item_code && row.qty) {\r\n        frappe.call({\r\n            method: \"frappe.client.get\",\r\n            args: {\r\n                doctype: \"Item\",\r\n                name: row.item_code\r\n            },\r\n            callback: function(r) {\r\n                if (r.message && r.message.uoms) {\r\n                    let uom_m2 = r.message.uoms.find(u => u.uom === \"m2\");\r\n                    if (uom_m2 && uom_m2.conversion_factor) {\r\n                        frappe.model.set_value(cdt, cdn, 'custom_cantidad_m2', row.qty * uom_m2.conversion_factor);\r\n                        frm.refresh_field('items');\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\nfunction calcular_precio_m2(frm, cdt, cdn) {\r\n    let row = locals[cdt][cdn];\r\n    if (row.item_code && row.rate) {\r\n        frappe.call({\r\n            method: \"frappe.client.get\",\r\n            args: {\r\n                doctype: \"Item\",\r\n                name: row.item_code\r\n            },\r\n            callback: function(r) {\r\n                if (r.message && r.message.uoms) {\r\n                    let uom_m2 = r.message.uoms.find(u => u.uom === \"m2\");\r\n                    if (uom_m2 && uom_m2.conversion_factor) {\r\n                        let precio_m2 = row.rate / uom_m2.conversion_factor;\r\n                        frappe.model.set_value(cdt, cdn, 'custom_precio_m2', precio_m2);\r\n                        frm.refresh_field('items');\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    }\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quotation",
  "enabled": 1,
  "modified": "2025-09-09 17:03:13.932244",
  "module": "Mdx Lcdp",
  "name": "Cotizacion_actualizacion_um",
  "script": "frappe.ui.form.on('Quotation Item', {\r\n    item_code: function(frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n        if (row.item_code) {\r\n            frappe.call({\r\n                method: \"frappe.client.get\",\r\n                args: {\r\n                    doctype: \"Item\",\r\n                    name: row.item_code\r\n                },\r\n                callback: function(r) {\r\n                    if (r.message && r.message.stock_uom) {\r\n                        frappe.model.set_value(cdt, cdn, 'uom', r.message.stock_uom);\r\n                        frm.refresh_field('items');\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    }\r\n});",
  "view": "Form"
 }
]